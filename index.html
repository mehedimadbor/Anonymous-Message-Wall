<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Message Board with Reactions (Session Storage)</title>
  <style>
    /* --- Reset & base --- */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 1rem auto;
      max-width: 700px;
      background: #f0f0f5;
      color: #333;
      padding: 1rem;
    }

    h1, h2 {
      text-align: center;
      color: #222;
    }

    /* --- Forms --- */
    form {
      background: #fff;
      padding: 1rem 1.2rem;
      margin-bottom: 1rem;
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    label {
      display: block;
      font-weight: 600;
      margin-top: 0.8rem;
    }

    input[type="text"],
    input[type="password"],
    textarea {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      resize: vertical;
      transition: border-color 0.3s ease;
    }
    input[type="text"]:focus,
    input[type="password"]:focus,
    textarea:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 4px #007bff;
    }
    textarea {
      min-height: 80px;
    }

    button {
      margin-top: 1rem;
      padding: 0.6rem 1.2rem;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }
    button:hover,
    button:focus {
      background-color: #0056b3;
      outline: none;
    }

    /* --- Messages --- */
    #messages {
      margin-top: 1rem;
    }
    .message {
      background: white;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
      position: relative;
      word-wrap: break-word;
    }
    .message p {
      margin: 0.3rem 0;
      line-height: 1.4;
    }
    .message small {
      color: #999;
      font-size: 0.85rem;
    }

    /* --- Reactions --- */
    .reactions {
      margin-top: 0.8rem;
    }
    .reactions button {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 1.25rem;
      margin-right: 1rem;
      padding: 0;
      color: #444;
      transition: color 0.2s ease;
    }
    .reactions button:hover,
    .reactions button:focus {
      color: #007bff;
      outline: none;
    }

    /* --- Delete button (admin) --- */
    .delete-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #dc3545;
      border: none;
      color: white;
      font-size: 0.85rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .delete-btn:hover,
    .delete-btn:focus {
      background-color: #b02a37;
      outline: none;
    }

    /* --- Modal --- */
    #infoModal {
      display: none;
      position: fixed;
      z-index: 1000;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    #infoModal.show {
      display: flex;
    }
    #infoModalContent {
      background: white;
      padding: 1.5rem 2rem;
      border-radius: 8px;
      width: 320px;
      max-width: 90%;
      position: relative;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      text-align: center;
    }
    #closeInfo {
      position: absolute;
      top: 10px;
      right: 12px;
      font-weight: bold;
      font-size: 1.5rem;
      cursor: pointer;
      color: #555;
      border: none;
      background: transparent;
      line-height: 1;
      padding: 0;
    }
    #closeInfo:hover,
    #closeInfo:focus {
      color: #000;
      outline: none;
    }
    #adminPinInput {
      width: 100%;
      padding: 0.5rem;
      margin-top: 1rem;
      margin-bottom: 0.8rem;
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      transition: border-color 0.3s ease;
    }
    #adminPinInput:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 4px #007bff;
    }
    #adminLoginStatus {
      font-weight: 600;
      margin-top: 0.4rem;
      min-height: 1.2rem;
    }

    /* --- Sort & Admin Buttons --- */
    #sortLikesBtn, #infoBtn {
      margin: 0 0.5rem 1rem 0;
      padding: 0.5rem 1rem;
      font-weight: 600;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      color: white;
      background-color: #28a745;
      transition: background-color 0.3s ease;
    }
    #sortLikesBtn:hover, #sortLikesBtn:focus {
      background-color: #1e7e34;
      outline: none;
    }
    #infoBtn {
      background-color: #6c757d;
    }
    #infoBtn:hover, #infoBtn:focus {
      background-color: #565e64;
      outline: none;
    }

    /* --- Checked Messages Section --- */
    #myMessagesTitle {
      margin-top: 2rem;
      text-align: center;
      color: #444;
    }
    #myMessages .message {
      background: #e9ecef;
    }

    /* Responsive */
    @media (max-width: 500px) {
      body {
        margin: 0.5rem;
        padding: 0.5rem;
      }
      form {
        padding: 0.8rem 1rem;
      }
      #infoModalContent {
        width: 90%;
        padding: 1rem 1.2rem;
      }
      #sortLikesBtn, #infoBtn {
        width: 48%;
        margin-bottom: 0.7rem;
      }
    }
  </style>
</head>
<body>
  <h1>Message Board with Reactions</h1>

  <form id="messageForm" aria-label="Send a message">
    <label for="fromInput">From (optional):</label>
    <input type="text" id="fromInput" name="fromInput" placeholder="Your name or leave blank" autocomplete="off" />

    <label for="toInput">To whom?</label>
    <input type="text" id="toInput" name="toInput" placeholder="Recipient's name" required autocomplete="off" />

    <label for="messageInput">Message:</label>
    <textarea id="messageInput" name="messageInput" required placeholder="Type your message here"></textarea>

    <button type="submit">Send Message</button>
  </form>

  <div style="display:flex; flex-wrap: wrap; justify-content: flex-start; margin-bottom: 1rem;">
    <button id="sortLikesBtn" aria-pressed="false" type="button">Sort by Top Likes</button>
    <button id="infoBtn" aria-haspopup="dialog" aria-controls="infoModal" type="button">Admin Login</button>
  </div>

  <div id="messages" aria-live="polite" aria-relevant="additions" role="region" aria-label="Messages"></div>

  <hr />

  <form id="checkForm" aria-label="Check messages sent to you">
    <label for="checkName">Check your messages by name:</label>
    <input type="text" id="checkName" name="checkName" placeholder="Enter your name" autocomplete="off" required />
    <button type="submit">Check Messages</button>
  </form>

  <h2 id="myMessagesTitle" style="display:none;">Messages sent to you:</h2>
  <div id="myMessages" role="region" aria-live="polite"></div>

  <!-- Admin Login Modal -->
  <div id="infoModal" role="dialog" aria-modal="true" aria-labelledby="infoModalLabel" tabindex="-1">
    <div id="infoModalContent">
      <button id="closeInfo" aria-label="Close admin login">&times;</button>
      <h2 id="infoModalLabel">Admin Login</h2>
      <input type="password" id="adminPinInput" placeholder="Enter Admin PIN" aria-label="Admin PIN" />
      <button id="adminLoginSubmitBtn" type="button">Login</button>
      <p id="adminLoginStatus" aria-live="assertive"></p>
    </div>
  </div>

  <script>
    // --- DOM references ---
    const form = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const messagesDiv = document.getElementById('messages');
    const fromInput = document.getElementById('fromInput');
    const toInput = document.getElementById('toInput');

    const checkForm = document.getElementById('checkForm');
    const checkNameInput = document.getElementById('checkName');
    const myMessagesDiv = document.getElementById('myMessages');
    const myMessagesTitle = document.getElementById('myMessagesTitle');

    const infoBtn = document.getElementById('infoBtn');
    const infoModal = document.getElementById('infoModal');
    const closeInfo = document.getElementById('closeInfo');

    const adminPinInput = document.getElementById('adminPinInput');
    const adminLoginSubmitBtn = document.getElementById('adminLoginSubmitBtn');
    const adminLoginStatus = document.getElementById('adminLoginStatus');

    const sortLikesBtn = document.getElementById('sortLikesBtn');

    // Encoded admin PIN (9272)
    const encodedAdminPin = 'OTI3Mg==';

    // Load messages & reacted indexes from sessionStorage
    let messages = JSON.parse(sessionStorage.getItem('messagesWithReacts') || '[]');
    let reacted = JSON.parse(sessionStorage.getItem('reactedMessages') || '[]');

    let isAdmin = false;
    let isSortedByLikes = false;

    // Utility: escape HTML special characters to avoid XSS
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    function renderMessages() {
      messagesDiv.innerHTML = '';
      if (messages.length === 0) {
        messagesDiv.innerHTML = '<p style="text-align:center; color:#777;">No messages yet.</p>';
        return;
      }

      // Clone for sorting
      let msgsToRender = [...messages];

      if (isSortedByLikes) {
        msgsToRender.sort((a,b) => (b.likes || 0) - (a.likes || 0));
      } else {
        msgsToRender.sort((a,b) => a.timestamp - b.timestamp);
      }

      msgsToRender.forEach((msg, idx) => {
        const from = msg.from ? escapeHtml(msg.from) : 'Anonymous';
        const to = msg.to ? escapeHtml(msg.to) : 'Unknown';
        const text = escapeHtml(msg.text);
        const date = new Date(msg.timestamp);
        const formattedDate = date.toLocaleString();

        const div = document.createElement('div');
        div.className = 'message';
        div.setAttribute('data-index', idx);

        let deleteBtnHTML = '';
        if (isAdmin) {
          deleteBtnHTML = `<button class="delete-btn" aria-label="Delete this message">Delete</button>`;
        }

        div.innerHTML = `
          <p><strong>From:</strong> ${from}</p>
          <p><strong>To:</strong> ${to}</p>
          <p>${text}</p>
          <small>Sent: ${formattedDate}</small>
          <div class="reactions">
            <button class="like-btn" aria-label="Like this message">👍 ${msg.likes || 0}</button>
            <button class="dislike-btn" aria-label="Dislike this message">👎 ${msg.dislikes || 0}</button>
          </div>
          ${deleteBtnHTML}
        `;
        messagesDiv.appendChild(div);
      });

      attachReactionListeners();
      attachDeleteListeners();
    }

    function attachReactionListeners() {
      const likeBtns = document.querySelectorAll('.like-btn');
      const dislikeBtns = document.querySelectorAll('.dislike-btn');

      likeBtns.forEach((btn, idx) => {
        btn.onclick = () => handleReaction(idx, 'like');
      });
      dislikeBtns.forEach((btn, idx) => {
        btn.onclick = () => handleReaction(idx, 'dislike');
      });
    }

    function handleReaction(index, type) {
      if(index < 0 || index >= messages.length) return;

      if(reacted.includes(index)){
        alert('You have already reacted to this message.');
        return;
      }

      if(type === 'like'){
        messages[index].likes = (messages[index].likes || 0) + 1;
      } else if(type === 'dislike'){
        messages[index].dislikes = (messages[index].dislikes || 0) + 1;
      }

      reacted.push(index);
      sessionStorage.setItem('messagesWithReacts', JSON.stringify(messages));
      sessionStorage.setItem('reactedMessages', JSON.stringify(reacted));
      renderMessages();
    }

    form.addEventListener('submit', (e) => {
      e.preventDefault();

      const from = fromInput.value.trim();
      const to = toInput.value.trim();
      const text = messageInput.value.trim();

      if (!to || !text) {
        alert('Please fill in the "To whom?" and message fields.');
        return;
      }

      messages.push({
        from,
        to,
        text,
        likes: 0,
        dislikes: 0,
        timestamp: Date.now()
      });

      sessionStorage.setItem('messagesWithReacts', JSON.stringify(messages));

      fromInput.value = '';
      toInput.value = '';
      messageInput.value = '';

      reacted = [];
      sessionStorage.setItem('reactedMessages', JSON.stringify(reacted));

      renderMessages();
      alert('Message sent successfully!');
    });

    checkForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const nameToCheck = checkNameInput.value.trim().toLowerCase();
      if (!nameToCheck) {
        alert('Please enter your name.');
        return;
      }

      const filtered = messages.filter(m => m.to.toLowerCase() === nameToCheck);

      myMessagesDiv.innerHTML = '';
      if (filtered.length === 0) {
        myMessagesTitle.style.display = 'none';
        myMessagesDiv.innerHTML = '<p style="color:#777; text-align:center;">No messages found for you.</p>';
      } else {
        myMessagesTitle.style.display = 'block';
        filtered.forEach(msg => {
          const from = msg.from ? escapeHtml(msg.from) : 'Anonymous';
          const text = escapeHtml(msg.text);
          const date = new Date(msg.timestamp);
          const formattedDate = date.toLocaleString();

          const div = document.createElement('div');
          div.className = 'message';
          div.innerHTML = `
            <p><strong>From:</strong> ${from}</p>
            <p>${text}</p>
            <small>Received: ${formattedDate}</small>
          `;
          myMessagesDiv.appendChild(div);
        });
      }
    });

    // Show admin modal
    infoBtn.addEventListener('click', () => {
      infoModal.classList.add('show');
      adminLoginStatus.textContent = '';
      adminPinInput.value = '';
      adminPinInput.focus();
    });

    // Close modal
    closeInfo.addEventListener('click', () => {
      infoModal.classList.remove('show');
    });

    window.addEventListener('click', (e) => {
      if (e.target === infoModal) {
        infoModal.classList.remove('show');
      }
    });

    // Admin login logic
    adminLoginSubmitBtn.addEventListener('click', () => {
      const enteredPin = adminPinInput.value.trim();
      if (!enteredPin) {
        adminLoginStatus.textContent = 'Please enter the PIN.';
        adminLoginStatus.style.color = 'red';
        return;
      }

      // Decode Base64 and compare
      const decodedPin = atob(encodedAdminPin);

      if (enteredPin === decodedPin) {
        isAdmin = true;
        adminLoginStatus.textContent = 'Admin login successful!';
        adminLoginStatus.style.color = 'green';

        setTimeout(() => {
          infoModal.classList.remove('show');
          renderMessages();
        }, 1000);
      } else {
        adminLoginStatus.textContent = 'Wrong PIN. Try again.';
        adminLoginStatus.style.color = 'red';
      }
    });

    // Delete message (admin only)
    function attachDeleteListeners() {
      if (!isAdmin) return;
      const deleteButtons = document.querySelectorAll('.delete-btn');
      deleteButtons.forEach((btn, idx) => {
        btn.onclick = () => {
          if (confirm('Are you sure you want to delete this message?')) {
            messages.splice(idx, 1);
            sessionStorage.setItem('messagesWithReacts', JSON.stringify(messages));
            renderMessages();
          }
        };
      });
    }

    // Sort messages by likes
    sortLikesBtn.addEventListener('click', () => {
      isSortedByLikes = !isSortedByLikes;
      sortLikesBtn.textContent = isSortedByLikes ? 'Show by Time' : 'Sort by Top Likes';
      sortLikesBtn.setAttribute('aria-pressed', isSortedByLikes.toString());
      renderMessages();
    });

    // Initial render
    renderMessages();
  </script>
</body>
</html>
